# =============================================================================
# TrustedGenAi - Deploy TEE Infrastructure
# =============================================================================
#
# Deploys TEE VMs to Azure with DeepSeek models and connects to VibeBrowser
# billing infrastructure at api.vibebrowser.app.
#
# Triggers:
#   - Manual dispatch with environment selection
#   - Push to main (plan only)
#
# Secrets required:
#   - AZURE_CREDENTIALS: Azure service principal JSON
#   - AZURE_SUBSCRIPTION_ID: Azure subscription ID
#   - TEE_API_KEY: API key for TEE LiteLLM endpoint
#   - CLOUDFLARE_TUNNEL_TOKEN: Cloudflare tunnel token for HTTPS
#
# =============================================================================

name: Deploy TEE Infrastructure

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - prod
      deployment_type:
        description: 'TEE deployment type'
        required: true
        default: 'cpu'
        type: choice
        options:
          - cpu    # Intel TDX (~$216/month)
          - gpu    # NVIDIA H100 CC (~$6,300/month)
      action:
        description: 'Terraform action'
        required: true
        default: 'plan'
        type: choice
        options:
          - plan
          - apply
          - destroy
  push:
    branches:
      - main
    paths:
      - 'terraform/**'
      - '.github/workflows/deploy-tee.yml'

env:
  TF_VERSION: '1.5.0'
  TF_WORKING_DIR: './terraform'

jobs:
  validate:
    name: Validate Terraform
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Format Check
        run: terraform fmt -check -recursive
        working-directory: ${{ env.TF_WORKING_DIR }}

      - name: Terraform Init
        run: terraform init -backend=false
        working-directory: ${{ env.TF_WORKING_DIR }}

      - name: Terraform Validate
        run: terraform validate
        working-directory: ${{ env.TF_WORKING_DIR }}

  plan:
    name: Plan ${{ github.event.inputs.deployment_type || 'cpu' }} TEE
    runs-on: ubuntu-latest
    needs: validate
    if: github.event_name == 'push' || github.event.inputs.action == 'plan'
    environment: ${{ github.event.inputs.environment || 'dev' }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Terraform Init
        run: |
          terraform init \
            -backend-config="resource_group_name=trustedgenai-tfstate-rg" \
            -backend-config="storage_account_name=trustedgenaitfstate" \
            -backend-config="container_name=tfstate" \
            -backend-config="key=${{ github.event.inputs.environment || 'dev' }}.terraform.tfstate"
        working-directory: ${{ env.TF_WORKING_DIR }}
        env:
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}

      - name: Terraform Plan
        id: plan
        run: |
          DEPLOY_TYPE="${{ github.event.inputs.deployment_type || 'cpu' }}"
          
          if [ "$DEPLOY_TYPE" = "cpu" ]; then
            VAR_FLAG="-var=enable_cpu_tee=true"
          else
            VAR_FLAG="-var=enable_gpu_tee=true"
          fi
          
          terraform plan \
            -var="azure_subscription_id=${{ secrets.AZURE_SUBSCRIPTION_ID }}" \
            -var="tee_api_key=${{ secrets.TEE_API_KEY }}" \
            $VAR_FLAG \
            -out=tfplan \
            -no-color
        working-directory: ${{ env.TF_WORKING_DIR }}
        env:
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}

      - name: Upload Plan
        uses: actions/upload-artifact@v4
        with:
          name: tfplan-${{ github.event.inputs.environment || 'dev' }}-${{ github.event.inputs.deployment_type || 'cpu' }}
          path: ${{ env.TF_WORKING_DIR }}/tfplan

      - name: Comment Plan on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const output = `#### Terraform Plan ðŸ“–
            
            **Environment:** \`${{ github.event.inputs.environment || 'dev' }}\`
            **Deployment Type:** \`${{ github.event.inputs.deployment_type || 'cpu' }}\`
            
            <details><summary>Show Plan</summary>
            
            \`\`\`
            ${{ steps.plan.outputs.stdout }}
            \`\`\`
            
            </details>
            
            *Pushed by: @${{ github.actor }}*`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            });

  deploy:
    name: Deploy ${{ github.event.inputs.deployment_type }} TEE
    runs-on: ubuntu-latest
    needs: plan
    if: github.event.inputs.action == 'apply'
    environment: ${{ github.event.inputs.environment }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Download Plan
        uses: actions/download-artifact@v4
        with:
          name: tfplan-${{ github.event.inputs.environment }}-${{ github.event.inputs.deployment_type }}
          path: ${{ env.TF_WORKING_DIR }}

      - name: Terraform Init
        run: |
          terraform init \
            -backend-config="resource_group_name=trustedgenai-tfstate-rg" \
            -backend-config="storage_account_name=trustedgenaitfstate" \
            -backend-config="container_name=tfstate" \
            -backend-config="key=${{ github.event.inputs.environment }}.terraform.tfstate"
        working-directory: ${{ env.TF_WORKING_DIR }}
        env:
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}

      - name: Terraform Apply
        run: terraform apply -auto-approve tfplan
        working-directory: ${{ env.TF_WORKING_DIR }}
        env:
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}

      - name: Get Outputs
        id: outputs
        run: |
          echo "public_ip=$(terraform output -raw deepseek_confidential_public_ip 2>/dev/null || echo 'N/A')" >> $GITHUB_OUTPUT
          echo "ssh_command=$(terraform output -raw deepseek_confidential_ssh_command 2>/dev/null || echo 'N/A')" >> $GITHUB_OUTPUT
        working-directory: ${{ env.TF_WORKING_DIR }}

      - name: Wait for VM to be ready
        run: |
          echo "Waiting 120 seconds for VM to initialize..."
          sleep 120

      - name: Verify TEE Attestation
        run: |
          PUBLIC_IP="${{ steps.outputs.outputs.public_ip }}"
          if [ "$PUBLIC_IP" != "N/A" ]; then
            echo "Checking attestation endpoint..."
            curl -s --retry 5 --retry-delay 30 "http://${PUBLIC_IP}:4001/v1/attestation" | jq '{platform, tee_verified, vm_size}'
          fi

      - name: Configure Cloudflare Tunnel
        if: success()
        run: |
          echo "Cloudflare tunnel configuration would be applied here"
          echo "Tunnel token stored in secrets.CLOUDFLARE_TUNNEL_TOKEN"
          # The tunnel is configured via cloud-init on the VM
          # This step verifies the tunnel is active
          
      - name: Deployment Summary
        run: |
          echo "## TEE Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | ${{ github.event.inputs.environment }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Type | ${{ github.event.inputs.deployment_type }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Public IP | ${{ steps.outputs.outputs.public_ip }} |" >> $GITHUB_STEP_SUMMARY
          echo "| SSH | ${{ steps.outputs.outputs.ssh_command }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Endpoints" >> $GITHUB_STEP_SUMMARY
          echo "- Attestation: https://tee.vibebrowser.app/attestation" >> $GITHUB_STEP_SUMMARY
          echo "- LiteLLM API: https://tee.vibebrowser.app/v1" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Billing Integration" >> $GITHUB_STEP_SUMMARY
          echo "TEE model \`deepseek-r1-tee\` is available to Max tier subscribers via api.vibebrowser.app" >> $GITHUB_STEP_SUMMARY

  destroy:
    name: Destroy ${{ github.event.inputs.deployment_type }} TEE
    runs-on: ubuntu-latest
    needs: validate
    if: github.event.inputs.action == 'destroy'
    environment: ${{ github.event.inputs.environment }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Terraform Init
        run: |
          terraform init \
            -backend-config="resource_group_name=trustedgenai-tfstate-rg" \
            -backend-config="storage_account_name=trustedgenaitfstate" \
            -backend-config="container_name=tfstate" \
            -backend-config="key=${{ github.event.inputs.environment }}.terraform.tfstate"
        working-directory: ${{ env.TF_WORKING_DIR }}
        env:
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}

      - name: Terraform Destroy
        run: |
          DEPLOY_TYPE="${{ github.event.inputs.deployment_type }}"
          
          if [ "$DEPLOY_TYPE" = "cpu" ]; then
            VAR_FLAG="-var=enable_cpu_tee=true"
          else
            VAR_FLAG="-var=enable_gpu_tee=true"
          fi
          
          terraform destroy \
            -var="azure_subscription_id=${{ secrets.AZURE_SUBSCRIPTION_ID }}" \
            -var="tee_api_key=${{ secrets.TEE_API_KEY }}" \
            $VAR_FLAG \
            -auto-approve
        working-directory: ${{ env.TF_WORKING_DIR }}
        env:
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}

      - name: Destroy Summary
        run: |
          echo "## TEE Infrastructure Destroyed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | ${{ github.event.inputs.environment }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Type | ${{ github.event.inputs.deployment_type }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Resources have been destroyed. Monthly cost savings:" >> $GITHUB_STEP_SUMMARY
          echo "- CPU TEE: ~\$216/month" >> $GITHUB_STEP_SUMMARY
          echo "- GPU TEE: ~\$6,300/month" >> $GITHUB_STEP_SUMMARY
