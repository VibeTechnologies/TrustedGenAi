# =============================================================================
# TrustedGenAi - Deploy GPU TEE Infrastructure (NVIDIA H100 CC)
# =============================================================================
#
# Deploys NVIDIA H100 Confidential Computing VMs to Azure with DeepSeek models.
# Endpoint: tee-gpu.vibebrowser.app
# Cost: ~$6,300/month (NCCads_H100_v5)
#
# WARNING: This is expensive infrastructure. Use sparingly.
#
# Secrets required:
#   - AZURE_CREDENTIALS: Azure service principal JSON
#   - AZURE_SUBSCRIPTION_ID: Azure subscription ID
#   - TEE_API_KEY: API key for TEE LiteLLM endpoint
#   - CLOUDFLARE_TUNNEL_TOKEN_GPU: Cloudflare tunnel token for tee-gpu.vibebrowser.app
#
# =============================================================================

name: Deploy GPU TEE (NVIDIA H100)

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - prod
      action:
        description: 'Terraform action'
        required: true
        default: 'plan'
        type: choice
        options:
          - plan
          - apply
          - destroy
      model_size:
        description: 'DeepSeek model to deploy'
        required: true
        default: '7b'
        type: choice
        options:
          - 7b      # DeepSeek-R1-Distill-Qwen-7B (~14GB VRAM)
          - 14b     # DeepSeek-R1-Distill-Qwen-14B (~28GB VRAM)
          - 32b     # DeepSeek-R1-Distill-Qwen-32B (~64GB VRAM)
          - 70b     # DeepSeek-R1-Distill-Llama-70B (80GB VRAM, full H100)

env:
  TF_VERSION: '1.5.0'
  TF_WORKING_DIR: './terraform'
  DEPLOYMENT_TYPE: 'gpu'
  ENDPOINT_DNS: 'tee-gpu.vibebrowser.app'

jobs:
  validate:
    name: Validate Terraform
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Format Check
        run: terraform fmt -check -recursive
        working-directory: ${{ env.TF_WORKING_DIR }}

      - name: Terraform Init
        run: terraform init -backend=false
        working-directory: ${{ env.TF_WORKING_DIR }}

      - name: Terraform Validate
        run: terraform validate
        working-directory: ${{ env.TF_WORKING_DIR }}

  cost-warning:
    name: Cost Warning
    runs-on: ubuntu-latest
    if: github.event.inputs.action == 'apply'
    steps:
      - name: Display Cost Warning
        run: |
          echo "::warning::GPU TEE deployment costs ~\$6,300/month (~\$210/day)"
          echo "::warning::Make sure to destroy when not in use"
          echo ""
          echo "## Cost Warning" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Monthly Cost | ~\$6,300 |" >> $GITHUB_STEP_SUMMARY
          echo "| Daily Cost | ~\$210 |" >> $GITHUB_STEP_SUMMARY
          echo "| Hourly Cost | ~\$8.75 |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Remember to run \`action: destroy\` when done testing." >> $GITHUB_STEP_SUMMARY

  plan:
    name: Plan GPU TEE (${{ github.event.inputs.model_size }})
    runs-on: ubuntu-latest
    needs: validate
    if: github.event.inputs.action == 'plan'
    environment: ${{ github.event.inputs.environment }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Terraform Init
        run: |
          terraform init \
            -backend-config="resource_group_name=trustedgenai-tfstate-rg" \
            -backend-config="storage_account_name=trustedgenaitfstate" \
            -backend-config="container_name=tfstate" \
            -backend-config="key=${{ github.event.inputs.environment }}-gpu.terraform.tfstate"
        working-directory: ${{ env.TF_WORKING_DIR }}
        env:
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}

      - name: Terraform Plan
        id: plan
        run: |
          terraform plan \
            -var="azure_subscription_id=${{ secrets.AZURE_SUBSCRIPTION_ID }}" \
            -var="tee_api_key=${{ secrets.TEE_API_KEY }}" \
            -var="enable_cpu_tee=false" \
            -var="enable_gpu_tee=true" \
            -var="gpu_model_size=${{ github.event.inputs.model_size }}" \
            -var="cloudflare_tunnel_token=${{ secrets.CLOUDFLARE_TUNNEL_TOKEN_GPU }}" \
            -var="endpoint_dns=${{ env.ENDPOINT_DNS }}" \
            -out=tfplan \
            -no-color
        working-directory: ${{ env.TF_WORKING_DIR }}
        env:
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}

      - name: Upload Plan
        uses: actions/upload-artifact@v4
        with:
          name: tfplan-${{ github.event.inputs.environment }}-gpu-${{ github.event.inputs.model_size }}
          path: ${{ env.TF_WORKING_DIR }}/tfplan

      - name: Plan Summary
        run: |
          echo "## GPU TEE Plan Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | ${{ github.event.inputs.environment }} |" >> $GITHUB_STEP_SUMMARY
          echo "| VM Size | NCCads_H100_v5 (NVIDIA H100 CC) |" >> $GITHUB_STEP_SUMMARY
          echo "| Model Size | ${{ github.event.inputs.model_size }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Estimated Cost | ~\$6,300/month |" >> $GITHUB_STEP_SUMMARY
          echo "| Endpoint | https://${{ env.ENDPOINT_DNS }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Run with \`action: apply\` to deploy." >> $GITHUB_STEP_SUMMARY

  deploy:
    name: Deploy GPU TEE (${{ github.event.inputs.model_size }})
    runs-on: ubuntu-latest
    needs: [validate, cost-warning]
    if: github.event.inputs.action == 'apply'
    environment: ${{ github.event.inputs.environment }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Terraform Init
        run: |
          terraform init \
            -backend-config="resource_group_name=trustedgenai-tfstate-rg" \
            -backend-config="storage_account_name=trustedgenaitfstate" \
            -backend-config="container_name=tfstate" \
            -backend-config="key=${{ github.event.inputs.environment }}-gpu.terraform.tfstate"
        working-directory: ${{ env.TF_WORKING_DIR }}
        env:
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}

      - name: Terraform Apply
        run: |
          terraform apply \
            -var="azure_subscription_id=${{ secrets.AZURE_SUBSCRIPTION_ID }}" \
            -var="tee_api_key=${{ secrets.TEE_API_KEY }}" \
            -var="enable_cpu_tee=false" \
            -var="enable_gpu_tee=true" \
            -var="gpu_model_size=${{ github.event.inputs.model_size }}" \
            -var="cloudflare_tunnel_token=${{ secrets.CLOUDFLARE_TUNNEL_TOKEN_GPU }}" \
            -var="endpoint_dns=${{ env.ENDPOINT_DNS }}" \
            -auto-approve
        working-directory: ${{ env.TF_WORKING_DIR }}
        env:
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}

      - name: Get Outputs
        id: outputs
        run: |
          echo "public_ip=$(terraform output -raw gpu_tee_public_ip 2>/dev/null || echo 'N/A')" >> $GITHUB_OUTPUT
          echo "ssh_command=$(terraform output -raw gpu_tee_ssh_command 2>/dev/null || echo 'N/A')" >> $GITHUB_OUTPUT
        working-directory: ${{ env.TF_WORKING_DIR }}

      - name: Wait for VM to be ready
        run: |
          echo "Waiting 180 seconds for GPU VM to initialize and load model..."
          sleep 180

      - name: Verify TEE Attestation
        run: |
          echo "Checking GPU TEE attestation endpoint..."
          curl -sf --retry 5 --retry-delay 30 "https://${{ env.ENDPOINT_DNS }}/v1/attestation" | jq '{platform, tee_verified, gpu_confidential, vm_size}' || echo "Attestation endpoint not yet available"

      - name: Verify LiteLLM Health
        run: |
          echo "Checking LiteLLM health..."
          curl -sf --retry 5 --retry-delay 30 "https://${{ env.ENDPOINT_DNS }}/health" || echo "Health endpoint not yet available"

      - name: Verify Model Loaded
        run: |
          echo "Checking available models..."
          curl -sf --retry 3 --retry-delay 30 "https://${{ env.ENDPOINT_DNS }}/v1/models" -H "Authorization: Bearer ${{ secrets.TEE_API_KEY }}" | jq '.data[].id' || echo "Models endpoint not yet available"

      - name: Deployment Summary
        run: |
          MODEL_NAME="deepseek-r1-distill-${{ github.event.inputs.model_size }}-tee"
          
          echo "## GPU TEE Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | ${{ github.event.inputs.environment }} |" >> $GITHUB_STEP_SUMMARY
          echo "| VM Size | NCCads_H100_v5 (80GB HBM3) |" >> $GITHUB_STEP_SUMMARY
          echo "| Model | ${{ github.event.inputs.model_size }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Public IP | ${{ steps.outputs.outputs.public_ip }} |" >> $GITHUB_STEP_SUMMARY
          echo "| SSH | ${{ steps.outputs.outputs.ssh_command }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Endpoints" >> $GITHUB_STEP_SUMMARY
          echo "- Attestation: https://${{ env.ENDPOINT_DNS }}/v1/attestation" >> $GITHUB_STEP_SUMMARY
          echo "- LiteLLM API: https://${{ env.ENDPOINT_DNS }}/v1" >> $GITHUB_STEP_SUMMARY
          echo "- Health: https://${{ env.ENDPOINT_DNS }}/health" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Models Available" >> $GITHUB_STEP_SUMMARY
          echo "- \`${MODEL_NAME}\` (GPU accelerated, H100 CC)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Billing Integration" >> $GITHUB_STEP_SUMMARY
          echo "GPU TEE models available to Max tier subscribers via api.vibebrowser.app" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Cost Reminder" >> $GITHUB_STEP_SUMMARY
          echo "This deployment costs ~\$210/day. Run \`action: destroy\` when done." >> $GITHUB_STEP_SUMMARY

  destroy:
    name: Destroy GPU TEE
    runs-on: ubuntu-latest
    needs: validate
    if: github.event.inputs.action == 'destroy'
    environment: ${{ github.event.inputs.environment }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Terraform Init
        run: |
          terraform init \
            -backend-config="resource_group_name=trustedgenai-tfstate-rg" \
            -backend-config="storage_account_name=trustedgenaitfstate" \
            -backend-config="container_name=tfstate" \
            -backend-config="key=${{ github.event.inputs.environment }}-gpu.terraform.tfstate"
        working-directory: ${{ env.TF_WORKING_DIR }}
        env:
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}

      - name: Terraform Destroy
        run: |
          terraform destroy \
            -var="azure_subscription_id=${{ secrets.AZURE_SUBSCRIPTION_ID }}" \
            -var="tee_api_key=${{ secrets.TEE_API_KEY }}" \
            -var="enable_cpu_tee=false" \
            -var="enable_gpu_tee=true" \
            -var="gpu_model_size=7b" \
            -var="cloudflare_tunnel_token=${{ secrets.CLOUDFLARE_TUNNEL_TOKEN_GPU }}" \
            -var="endpoint_dns=${{ env.ENDPOINT_DNS }}" \
            -auto-approve
        working-directory: ${{ env.TF_WORKING_DIR }}
        env:
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}

      - name: Destroy Summary
        run: |
          echo "## GPU TEE Infrastructure Destroyed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | ${{ github.event.inputs.environment }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Endpoint | ${{ env.ENDPOINT_DNS }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Monthly cost savings: ~\$6,300/month" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "GPU TEE resources have been destroyed." >> $GITHUB_STEP_SUMMARY
